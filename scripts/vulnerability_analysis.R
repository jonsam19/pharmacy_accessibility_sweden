# =============================================================================
# Pharmacy Vulnerability Analysis
# =============================================================================
# This script calculates pharmacy criticality scores by measuring the impact
# if each pharmacy were to close. For each pharmacy, we identify all people
# who have it as their nearest pharmacy and calculate how much extra distance
# they would need to travel to reach their second-nearest alternative.
#
# The "person-km impact" score represents the total additional distance burden
# on the population if that specific pharmacy were to close.
#
# Run this after prepare_input_files.R
# =============================================================================

# Libraries -------------------------------------------------------------------
library(tidyverse)
library(sf)
library(geosphere)

# Load Data -------------------------------------------------------------------
message("Loading data...")

# Determine data directory path (handle running from scripts/ or root)
data_dir <- if (dir.exists("data/processed")) "data/processed" else "../data/processed"

df_apotek <- readRDS(file.path(data_dir, "df_apotek.rds"))
message(sprintf("  ✓ Loaded %d pharmacies", nrow(df_apotek)))

df_rutor <- readRDS(file.path(data_dir, "df_rutor.rds")) |>
  st_drop_geometry()
message(sprintf("  ✓ Loaded %d populated grid squares (population: %s)",
                nrow(df_rutor),
                format(sum(df_rutor$pop), big.mark = ",")))

# Validate Data ---------------------------------------------------------------
if (!exists("df_apotek") || nrow(df_apotek) == 0) {
  stop("Error: df_apotek not loaded or empty. ",
       "Please run scripts/prepare_input_files.R first.")
}

if (!exists("df_rutor") || nrow(df_rutor) == 0) {
  stop("Error: df_rutor not loaded or empty. ",
       "Please run scripts/prepare_input_files.R first.")
}

message("  ✓ Data validation passed")

# Calculate Distance Matrix ---------------------------------------------------
message("\nCalculating distances between all population squares and pharmacies...")
message("  (This may take a few minutes)")

# Extract coordinates
pop_coords <- df_rutor |>
  select(long, lat) |>
  as.matrix()

pharm_coords <- df_apotek |>
  select(long, lat) |>
  as.matrix()

# Calculate Haversine distances (in metres) from each grid square to all pharmacies
# Result: matrix where rows = population grid squares, columns = pharmacies
dist_matrix <- distm(pop_coords, pharm_coords, fun = distHaversine)

# Convert to kilometres
dist_matrix_km <- dist_matrix / 1000

message(sprintf("  ✓ Calculated %s distances",
                format(nrow(dist_matrix_km) * ncol(dist_matrix_km), big.mark = ",")))

# Find Nearest and Second-Nearest Pharmacies ---------------------------------
message("\nIdentifying nearest and second-nearest pharmacies for each grid square...")

# For each grid square (row), find index of nearest pharmacy
nearest_idx <- apply(dist_matrix_km, 1, which.min)

# For each grid square, find distance to nearest pharmacy
dist_to_1st <- apply(dist_matrix_km, 1, min)

# For each grid square, find distance to second-nearest pharmacy
# We need to exclude the nearest and find the minimum of what remains
dist_to_2nd <- sapply(1:nrow(dist_matrix_km), function(i) {
  # Get all distances for this grid square
  distances <- dist_matrix_km[i, ]
  # Set the nearest distance to infinity to exclude it
  distances[nearest_idx[i]] <- Inf
  # Return the minimum of remaining distances
  min(distances)
})

# Create assignment data frame
grid_assignments <- tibble(
  grid_id = df_rutor$id,
  population = df_rutor$pop,
  nearest_pharmacy_id = df_apotek$pharmacy_id[nearest_idx],
  dist_to_1st_km = dist_to_1st,
  dist_to_2nd_km = dist_to_2nd,
  extra_distance_km = dist_to_2nd_km - dist_to_1st_km
)

message(sprintf("  ✓ Assigned %d grid squares to their nearest pharmacies",
                nrow(grid_assignments)))

# Calculate Pharmacy Criticality Scores --------------------------------------
message("\nCalculating pharmacy criticality scores...")

pharmacy_criticality <- grid_assignments |>
  group_by(nearest_pharmacy_id) |>
  summarise(
    n_grid_squares = n(),
    population_served = sum(population),
    mean_dist_to_1st_km = weighted.mean(dist_to_1st_km, population),
    mean_dist_to_2nd_km = weighted.mean(dist_to_2nd_km, population),
    mean_extra_distance_km = weighted.mean(extra_distance_km, population),
    max_extra_distance_km = max(extra_distance_km),
    # Total person-km impact if this pharmacy closes
    person_km_impact = sum(population * extra_distance_km),
    .groups = "drop"
  ) |>
  # Join pharmacy metadata
  left_join(
    df_apotek |> select(pharmacy_id, namn, kommun, lan, lat, long),
    by = c("nearest_pharmacy_id" = "pharmacy_id")
  ) |>
  # Calculate rank (1 = most critical)
  arrange(desc(person_km_impact)) |>
  mutate(
    criticality_rank = row_number(),
    .before = 1
  )

message(sprintf("  ✓ Calculated criticality scores for %d pharmacies",
                nrow(pharmacy_criticality)))

# Summary Statistics ----------------------------------------------------------
message(paste0("\n", strrep("=", 70)))
message("PHARMACY VULNERABILITY ANALYSIS - SUMMARY")
message(strrep("=", 70))

message("\nTop 10 Most Critical Pharmacies:")
message(sprintf("%-5s %-40s %-20s %15s", "Rank", "Name", "Municipality", "Person-km Impact"))
message(strrep("-", 80))

top_10 <- pharmacy_criticality |>
  head(10) |>
  mutate(
    namn = str_trunc(namn, 38),
    kommun = str_trunc(kommun, 18)
  )

for (i in 1:nrow(top_10)) {
  message(sprintf("%-5d %-40s %-20s %15s",
                  top_10$criticality_rank[i],
                  top_10$namn[i],
                  top_10$kommun[i],
                  format(round(top_10$person_km_impact[i], 0), big.mark = ",")))
}

message(paste0("\n", strrep("-", 80)))

# Overall statistics
total_population <- sum(pharmacy_criticality$population_served)
total_impact <- sum(pharmacy_criticality$person_km_impact)
mean_impact <- mean(pharmacy_criticality$person_km_impact)
median_impact <- median(pharmacy_criticality$person_km_impact)

message(sprintf("\nTotal population analyzed: %s",
                format(total_population, big.mark = ",")))
message(sprintf("Total pharmacies analyzed: %d",
                nrow(pharmacy_criticality)))
message(sprintf("\nAverage person-km impact per pharmacy: %s",
                format(round(mean_impact, 0), big.mark = ",")))
message(sprintf("Median person-km impact per pharmacy: %s",
                format(round(median_impact, 0), big.mark = ",")))
message(sprintf("Maximum person-km impact: %s (Rank #1: %s)",
                format(round(max(pharmacy_criticality$person_km_impact), 0), big.mark = ","),
                pharmacy_criticality$namn[1]))

message(paste0("\n", strrep("=", 70)))

# Save Results ----------------------------------------------------------------
output_dir <- if (dir.exists("data")) "data/results" else "../data/results"
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
}

# Save detailed criticality scores
output_file <- file.path(output_dir, "pharmacy_criticality.rds")
saveRDS(pharmacy_criticality, output_file)
message(sprintf("\n✓ Detailed results saved to: %s", output_file))

# Save grid assignments (useful for further analysis)
assignments_file <- file.path(output_dir, "grid_pharmacy_assignments.rds")
saveRDS(grid_assignments, assignments_file)
message(sprintf("✓ Grid assignments saved to: %s", assignments_file))

message("\nAnalysis complete!")
